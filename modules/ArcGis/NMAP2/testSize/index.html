<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <title>
      Point clustering - filter popup features | Sample | ArcGIS API for
      JavaScript 4.25
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.25/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.25/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <script>
      require([
        "esri/WebMap",
        "esri/config",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/smartMapping/labels/clusters",
      ], function (
        WebMap,
        esriConfig,
        MapView,
        FeatureLayer,
        Legend,
        Expand,
        clusterLabelCreator
      )
	  
 
	  {
		esriConfig.apiKey =
          "AAPK8bc6dada19fc40b495ff8ef292a6162bPTUaWG0rfCO_sIehiCZr8W72weLqN42yKhTPDbTK4S0XbpfyQYfb5RiVUvKkD9AB";
        const layer = new FeatureLayer({
          portalItem: {
            id: "0cb0d5fa711143948603dcc8d9a8534d",
          },
        });

        const map = new WebMap({
          basemap: "arcgis-topographic",
          layers: [layer],
        });

        const view = new MapView({
          container: "viewDiv",
          map,
		  center: [15.75, 50.62],
          zoom: 11,
        //   extent: {
        //     spatialReference: {
        //       latestWkid: 3857,
        //       wkid: 102100,
        //     },
        //     xmin: -15327459,
        //     ymin: 2740044,
        //     xmax: -6076744,
        //     ymax: 6878650,
        //   },
          popup: {
            dockEnabled: true,
            dockOptions: {
              breakpoint: false,
              position: "top-right",
            },
          },
        });

        view.ui.add(
          new Expand({
            content: new Legend({ view }),
            view,
          }),
          "top-left"
        );

        layer
          .when()
          .then(generateClusterConfig)
          .then(async (featureReduction) => {
            // sets generated cluster configuration on the layer
            layer.featureReduction = featureReduction;

            // Disable clustering when user zooms beyond a 1:50,000 scale level
            // Re-enable clustering when the user zooms out to a scale smaller than 1:50,000
            view.watch("scale", function (scale) {
              layer.featureReduction =
                view.scale > 50000 ? featureReduction : null;
            });
          })
          .catch((error) => {
            console.error(error);
          });

        async function generateClusterConfig(layer) {
          let popupTemplate = {
            title: "Přehled sektorů",
            content: `<p>Tento shluk představuje <b>{cluster_count}</b> podniků z toho <b>{expression/Primar}</b> primárního sektoru,
				<b>{expression/Sekundar}</b> sekundárního sektoru a <b>{expression/Terciar}</b> terciárního sektoru.</p>	`,
            expressionInfos: [
              {
                name: "Sekundar",
                title: "Sekundar",
                expression: `
                // returns the total number of coal power plants
                Count(Filter($aggregatedFeatures, "Sektor = 'Sekundární'"))
              `,
              },
			  {
                name: "Primar",
                title: "Primar",
                expression: `
                // returns the total number of coal power plants
                Count(Filter($aggregatedFeatures, "Sektor = 'Primární'"))
              `,
              },
			  {
                name: "Terciar",
                title: "Terciar",
                expression: `
                // returns the total number of coal power plants
                Count(Filter($aggregatedFeatures, "Sektor = 'Terciární'"))
              `,
              },
			  
              {
                name: "Coal-mw-sum",
                title: "Coal-mw-sum",
                expression: `
                // returns the amount of electricity generated by coal
                // in this cluster as a ratio to the total capacity
                // of plants included in the cluster
                Expects($aggregatedFeatures, "capacity_mw")
                var mWtotal = Sum($aggregatedFeatures, "capacity_mw");
                var mWCoal = Sum(Filter($aggregatedFeatures, "fuel1 = 'Coal'"), "capacity_mw");
                if(mWCoal < 1){
                  return "none";
                }
                var mWratio = Round(mWCoal / mWtotal, 4);
                return \`\${Text(mWratio, "#.#%")} (\${Text(mWCoal, "#,### mW")})\`;
              `,
              },
            ],
          };

          // generates default labelingInfo
          const { labelingInfo, clusterMinSize } = await clusterLabelCreator
            .getLabelSchemes({
              layer,
              view,
            })
            .then((labelSchemes) => labelSchemes.primaryScheme);

          return {
            type: "cluster",
            popupTemplate,
            labelingInfo,
            clusterMinSize,
          };
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
